name: lxd
base: core20
assumes:
  - snapd2.39
version: "5.0.0"
grade: stable
summary: LXD - container and VM manager
description: |-
 LXD is a system container and virtual machine manager.

 It offers a simple CLI and REST API to manage local or remote instances,
 uses an image based workflow and support for a variety of advanced features.

 Images are available for all Ubuntu releases and architectures as well
 as for a wide number of other Linux distributions. Existing
 integrations with many deployment and operation tools, makes it work
 just like a public cloud, except everything is under your control.

 LXD containers are lightweight, secure by default and a great
 alternative to virtual machines when running Linux on Linux.

 LXD virtual machines are modern and secure, using UEFI and secure-boot
 by default and a great choice when a different kernel or operating
 system is needed.

 With clustering, up to 50 LXD servers can be easily joined and managed
 together with the same tools and APIs and without needing any external
 dependencies.


 Supported configuration options for the snap (snap set lxd [<key>=<value>...]):

   - ceph.builtin: Use snap-specific Ceph configuration [default=false]
   - ceph.external: Use the system's ceph tools (ignores ceph.builtin) [default=false]
   - criu.enable: Enable experimental live-migration support [default=false]
   - daemon.debug: Increase logging to debug level [default=false]
   - daemon.group: Set group of users that have full control over LXD [default=lxd]
   - daemon.user.group: Set group of users that have restricted LXD access [default=lxd]
   - daemon.preseed: Pass a YAML configuration to `lxd init` on initial start
   - daemon.syslog: Send LXD log events to syslog [default=false]
   - daemon.verbose: Increase logging to verbose level [default=false]
   - lvm.external: Use the system's LVM tools [default=false]
   - lxcfs.pidfd: Start per-container process tracking [default=false]
   - lxcfs.loadavg: Start tracking per-container load average [default=false]
   - lxcfs.cfs: Consider CPU shares for CPU usage [default=false]
   - openvswitch.builtin: Run a snap-specific OVS daemon [default=false]
   - openvswitch.external: Use the system's OVS tools (ignores openvswitch.builtin) [default=false]
   - ovn.builtin: Use snap-specific OVN configuration [default=false]
   - shiftfs.enable: Enable shiftfs support [default=auto]

 For system-wide configuration of the CLI, place your configuration in
 /var/snap/lxd/common/global-conf/ (config.yml and servercerts)

contact: lxc-devel@lists.linuxcontainers.org
issues: https://github.com/lxc/lxd/issues
source-code: https://github.com/lxc/lxd
website: https://linuxcontainers.org/lxd
confinement: strict

apps:
  # Main commands
  activate:
    command: commands/daemon.activate
    daemon: oneshot
    plugs:
      - lxd-support
      - system-observe

  daemon:
    command: commands/daemon.start
    reload-command: commands/daemon.reload
    stop-command: commands/daemon.stop
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    slots:
      - lxd
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd/unix.socket
        socket-mode: 0660

  user-daemon:
    command: commands/lxd-user
    stop-timeout: 600s
    restart-condition: on-failure
    daemon: simple
    plugs:
      - lxd-support
      - network-bind
      - system-observe
    sockets:
      unix:
        listen-stream: $SNAP_COMMON/lxd-user/unix.socket
        socket-mode: 0660

  lxc:
    command: commands/lxc
    completer: etc/bash_completion.d/snap.lxd.lxc
    plugs:
      - lxd-support
      - system-observe

  lxd:
    command: commands/lxd
    plugs:
      - lxd-support
      - system-observe

  # Sub-commands
  benchmark:
    command: commands/lxd-benchmark
    plugs:
      - lxd-support
      - system-observe
  buginfo:
    command: commands/buginfo
    plugs:
      - lxd-support
      - system-observe
  check-kernel:
    command: commands/lxd-check-kernel
    plugs:
      - lxd-support
      - system-observe
  lxc-to-lxd:
    command: commands/lxc-to-lxd
    plugs:
      - lxd-support
      - system-observe
  migrate:
    command: commands/lxd-migrate
    plugs:
      - lxd-support
      - system-observe

hooks:
  configure:
    plugs:
      - lxd-support
      - network
      - system-observe
  remove:
    plugs:
      - lxd-support
      - system-observe

parts:
  # Workarounds
  pull-meson-early:
    source: snapcraft/empty
    override-build: |
      # No-op
      true
    override-stage: |
      # No-op
      true
    plugin: nil
    override-pull: |
      # Fetch meson early to cause all downloads at the beginning of the build.
      python3 -m pip install -U meson

  # Dependencies
  btrfs:
    build-attributes: [core22-step-dependencies]
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - btrfs-progs
    organize:
      sbin/: bin/
    prime:
      - bin/btrfs
      - bin/btrfstune
      - bin/mkfs.btrfs

  ceph:
    build-attributes: [core22-step-dependencies]
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - ceph-common
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
    prime:
      - bin/ceph
      - bin/rbd
      - lib/*/ceph
      - lib/*/libatomic.so*
      - lib/*/libboost_iostreams.so*
      - lib/*/libboost_program_options.so*
      - lib/*/libboost_thread.so*
      - lib/*/libcephfs*
      - lib/*/libibverbs.so*
      - lib/*/librados.so*
      - lib/*/librbd.so*
      - lib/*/librdmacm.so*
      - lib/*/libsnappy.so*
      - lib/python3

  criu:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/checkpoint-restore/criu
    source-tag: v3.17.1
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - asciidoc
      - libcap-dev
      - libnet1-dev
      - libnl-3-dev
      - libprotobuf-c-dev
      - libprotobuf-dev
      - protobuf-c-compiler
      - protobuf-compiler
      - xmlto
    stage-packages:
      - libnet1
      - libprotobuf-c1
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "armv7l" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      make
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/criu/"
      cp criu/criu "${SNAPCRAFT_PART_INSTALL}/criu/"
    organize:
      usr/lib/: lib/
    prime:
      - criu/*
      - lib/*/libnet*
      - lib/*/libproto*

  dqlite:
    build-attributes: [core22-step-dependencies]
    after:
      - raft
      - sqlite
    source: https://github.com/canonical/dqlite
    source-type: git
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    stage-packages:
      - libuv1
    build-packages:
      - libuv1-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libdqlite*so*
      - lib/*/libuv*

  edk2:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/tianocore/edk2
    source-type: git
    source-tag: IRRELEVANT
    source-depth: 1
    plugin: nil
    build-packages:
      - on amd64:
        - acpica-tools
        - nasm
        - uuid-dev
      - on arm64:
        - acpica-tools
        - nasm
        - uuid-dev
    override-pull: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0
      set -ex
      git clone https://github.com/tianocore/edk2 . -b edk2-stable202202

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      # Fix submodules
      sed -i "s#https://git.cryptomilk.org/projects/cmocka#https://gitlab.com/cmocka/cmocka#g" .gitmodules
      git submodule update --init --recursive

      # Apply patches
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0001-force-DUID-LLT.patch"
      cp "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0002-logo.bmp" MdeModulePkg/Logo/Logo.bmp
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0003-boot-delay.patch"
      patch -p1 < "${SNAPCRAFT_PROJECT_DIR}/patches/edk2-0004-gcc-errors.patch"

      ARCH="X64"
      PKG="OvmfPkg/OvmfPkgX64.dsc"
      FV_CODE="OVMF_CODE"
      FV_VARS="OVMF_VARS"
      if [ "$(uname -m)" = "aarch64" ]; then
          ARCH="AARCH64"
          PKG="ArmVirtPkg/ArmVirtQemu.dsc"
          FV_CODE="QEMU_EFI"
          FV_VARS="QEMU_VARS"
      fi

      # Run in a bash sub-shell as edksetup.sh requires it
      set -ex
      (
      cat << EOF
          . ./edksetup.sh
          make -C BaseTools ARCH=${ARCH}
          build -a ${ARCH} -t GCC49 -b RELEASE -p ${PKG} \
            -DSECURE_BOOT_ENABLE=TRUE \
            -DNETWORK_IP4_ENABLE=TRUE \
            -DNETWORK_IP6_ENABLE=TRUE \
            -DNETWORK_TLS_ENABLE=TRUE \
            -DNETWORK_HTTP_BOOT_ENABLE=TRUE \
            -DFD_SIZE_2MB \
            -DTPM_ENABLE=TRUE \
            -DTPM_CONFIG_ENABLE=TRUE \
            -DTPM2_ENABLE=TRUE \
            -DTPM2_CONFIG_ENABLE=TRUE
      EOF
      ) | bash -e

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      cp Build/*/*/FV/${FV_CODE}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
      cp Build/*/*/FV/${FV_VARS}.fd "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"

      if [ "$(uname -m)" = "aarch64" ]; then
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_CODE.fd"
          truncate -s 64m "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.fd"
      fi

    prime:
      - share/qemu/*

  libmnl:
    build-attributes: [core22-step-dependencies]
    source: https://git.netfilter.org/libmnl
    source-type: git
    source-tag: libmnl-1.0.5
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    organize:
      usr/lib/: lib/
    prime:
      - lib/libmnl*so*

  libnftnl:
    build-attributes: [core22-step-dependencies]
    after:
      - libmnl
    source: https://git.netfilter.org/libnftnl
    source-type: git
    source-tag: libnftnl-1.2.2
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    organize:
      usr/lib/: lib/
    prime:
      - lib/libnftnl*so*
    override-build: |
      snapcraftctl build

      sed -i "s# /lib/libmnl.la# ${SNAPCRAFT_STAGE}/lib/libmnl.la#g" "${SNAPCRAFT_PART_INSTALL}/lib/libnftnl.la"

  libseccomp:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/seccomp/libseccomp
    source-type: git
    source-tag: v2.5.4
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    build-packages:
      - gperf
    organize:
      usr/lib/: lib/
    prime:
      - lib/libseccomp*so*

  libtpms:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/stefanberger/libtpms
    source-type: git
    source-tag: v0.9.5
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --with-tpm2
      - --with-openssl
    organize:
      usr/lib/: lib/
    prime:
      - lib/libtpms*so*

  liburing:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/axboe/liburing
    source-type: git
    source-tag: liburing-2.2
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0
      snapcraftctl build
    organize:
      usr/lib/: lib/
    prime:
      - lib/liburing*so*

  libusb:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/libusb/libusb
    source-type: git
    source-tag: v1.0.26
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    organize:
      usr/lib/: lib/
    prime:
      - lib/libusb*so*

  logrotate:
    build-attributes: [core22-step-dependencies]
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - logrotate
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    stage:
      - bin/logrotate
    prime:
      - bin/logrotate

  lvm:
    build-attributes: [core22-step-dependencies]
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - dmeventd
      - lvm2
      - thin-provisioning-tools
    organize:
      sbin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/cache_*
      - bin/dmeventd
      - bin/era_*
      - bin/lv*
      - bin/pdata_tools
      - bin/pv*
      - bin/thin_*
      - bin/vg*
      - -bin/vgimportclone
      - -bin/lvmconf
      - -bin/lvmdump
      - -bin/lvmetad
      - -bin/lvmpolld
      - etc/lvm/lvm.conf
      - lib/*/device-mapper/*
      - lib/*/libaio.so*
      - lib/*/libdevmapper*
      - lib/*/liblvm*
      - lib/*/libreadline.so*

  nano:
    build-attributes: [core22-step-dependencies]
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - nano
    organize:
      usr/bin/: bin/
    prime:
      - bin/nano
      - etc/nanorc

  nftables:
    build-attributes: [core22-step-dependencies]
    after:
      - libmnl
      - libnftnl
    source: https://git.netfilter.org/nftables
    source-type: git
    source-tag: v1.0.4
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --with-json
    build-packages:
      - libedit-dev
      - libjansson-dev
      - libreadline-dev
    stage-packages:
      - libjansson4
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      set +ex
      snapcraftctl build
      set -ex
    organize:
      sbin/: bin/
      usr/lib/: lib/
    prime:
      - bin/nft
      - lib/*/libjansson*so*
      - lib/libnftables*so*

  nvidia-container:
    build-attributes: [core22-step-dependencies]
    after:
      - libseccomp
    source: https://github.com/NVIDIA/libnvidia-container
    source-type: git
    source-tag: v1.10.0
    source-depth: 1
    plugin: make
    build-packages:
      - bmake
      - curl
      - lsb-release
    override-build: |-
      set -ex

      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git am "${SNAPCRAFT_PROJECT_DIR}/patches/nvidia-0001-libgcc.patch"  # Preload libgcc_s.so.1 on arm64 systems

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/bin/"
      cp ${SNAPCRAFT_PROJECT_DIR}/snapcraft/wrappers/nvidia-container-cli "${SNAPCRAFT_PART_INSTALL}/bin/"

      set +ex
      snapcraftctl build
    organize:
      usr/local/bin/nvidia-container-cli: bin/nvidia-container-cli.real
      usr/local/lib: lib/
    prime:
      - bin/nvidia-container-cli*
      - lib/libnvidia-container*.so*

  openvswitch:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/openvswitch/ovs
    source-type: git
    source-tag: v2.17.2
    plugin: autotools
    autotools-configure-parameters:
      - --enable-ssl
      - --prefix=
    stage-packages:
      - uuid-runtime
    override-build: |
      set -ex

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git am "${SNAPCRAFT_PROJECT_DIR}/patches/ovs-0001-idl-support-write-only.patch"  # ovsdb-idl: Support write-only-changed IDL monitor mode.

      set +ex
      snapcraftctl build
      set -ex
    organize:
      sbin/: bin/
      usr/bin/: bin/
    prime:
      - bin/ovs-appctl
      - bin/ovs-vsctl
      - bin/ovs-vswitchd
      - bin/ovsdb-*
      - bin/uuidgen
      - share/openvswitch/

  ovn:
    build-attributes: [core22-step-dependencies]
    after:
      - openvswitch
    source: https://github.com/ovn-org/ovn
    source-type: git
    source-tag: v22.06.0
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --enable-ssl
      - --prefix=
      - --with-ovs-source=../../openvswitch/build/
    prime:
      - bin/ovn-nbctl
      - bin/ovn-sbctl

  spice-protocol:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/freedesktop/spice-protocol
    source-type: git
    source-tag: v0.14.4
    source-depth: 1
    plugin: meson
    prime: []

  spice-server:
    build-attributes: [core22-step-dependencies]
    after:
      - spice-protocol
    source: https://github.com/freedesktop/spice
    source-type: git
    source-tag: v0.15.0
    source-depth: 1
    plugin: meson
    meson-parameters:
      - --prefix=/
      - -Dgstreamer=no
      - -Dmanual=false
      - -Dlz4=false
      - -Dsasl=false
      - -Dopus=disabled
      - -Dsmartcard=disabled
      - -Dtests=false
    build-packages:
      - libjpeg-turbo8-dev
      - python3-pyparsing
      - python3-six
    stage-packages:
      - libjpeg-turbo8
      - libpixman-1-0
    organize:
      sbin/: bin/
      usr/lib: lib/
      usr/local/lib/: lib/
    prime:
      - lib/*/libjpeg*so*
      - lib/*/libspice-server*so*
      - lib/*/libpixman*so*

  swtpm:
    build-attributes: [core22-step-dependencies]
    after:
      - libseccomp
      - libtpms
    source: https://github.com/stefanberger/swtpm
    source-type: git
    source-tag: v0.7.3
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
      - --with-seccomp
      - --with-openssl
      - --without-cuse
    build-packages:
      - expect
      - gawk
      - iproute2
      - libjson-glib-dev
      - python3-cryptography
      - python3-setuptools
      - socat
    stage-packages:
      - libjson-glib-1.0-0
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      lib/swtpm/: lib/
    prime:
      - bin/swtpm
      - lib/libswtpm*so*
      - lib/*/libjson-glib-1.0.so*

  qemu:
    build-attributes: [core22-step-dependencies]
    after:
      - libseccomp
      - liburing
      - libusb
      - spice-protocol
      - spice-server
    source: IRRELEVANT
    source-type: git
    source-tag: IRRELEVANT
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --disable-bochs
      - --disable-cloop
      - --disable-dmg
      - --disable-docs
      - --disable-guest-agent
      - --disable-parallels
      - --disable-qed
      - --disable-slirp
      - --disable-user
      - --disable-vdi
      - --disable-vnc
      - --disable-xen
      - --enable-attr
      - --enable-cap-ng
      - --enable-kvm
      - --enable-libusb
      - --enable-usb-redir
      - --enable-linux-aio
      - --enable-linux-io-uring
      - --enable-numa
      - --enable-pie
      - --enable-rbd
      - --enable-seccomp
      - --enable-spice
      - --enable-system
      - --enable-tcg
      - --enable-tools
      - --enable-vhost-crypto
      - --enable-vhost-kernel
      - --enable-vhost-net
      - --enable-vhost-scsi
      - --enable-vhost-user
      - --enable-vhost-vsock
      - --enable-virtfs
      - --firmwarepath=/snap/lxd/current/share/qemu/
      - --localstatedir=/var/
    build-packages:
      - bison
      - flex
      - pkg-config
      - libaio-dev
      - libcap-ng-dev
      - libglib2.0-dev
      - libnuma-dev
      - libpixman-1-dev
      - librbd-dev
      - libusbredirhost-dev
    stage-packages:
      - genisoimage
      - libmagic1
      - libnuma1
      - libpixman-1-0
      - libusbredirhost1
      - libusbredirparser1
    override-pull: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0
      set -ex
      git clone https://gitlab.com/qemu/qemu . -b v7.0.0
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && [ "$(uname -m)" != "ppc64le" ] && [ "$(uname -m)" != "s390x" ] && exit 0

      set -ex
      # Mangle the configure a bit
      QEMUARCH="$(uname -m)"
      [ "${QEMUARCH}" = "ppc64le" ] && QEMUARCH="ppc64"
      sed -i "s/^unset target_list$/target_list=\"${QEMUARCH}-softmmu\"/" configure
      sed -i 's#libseccomp_minver=".*#libseccomp_minver="0.0"#g' configure

      set +ex
      snapcraftctl build
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/local/bin/: bin/
      usr/local/lib/: lib/
      usr/local/libexec/: bin/
      usr/local/share/: share/
    prime:
      - bin/genisoimage*
      - bin/mkisofs*
      - bin/qemu-system-*
      - bin/qemu-img*
      - bin/virtfs-proxy-helper*
      - bin/virtiofsd*
      - lib/*/libatomic.so*
      - lib/*/libmagic*so*
      - lib/*/libnuma*so*
      - lib/*/libpixman*so*
      - lib/*/libusbredir*so*
      - share/qemu/keymaps*
      - share/qemu/efi-virtio.rom*
      - share/qemu/kvmvapic.bin*
      - share/qemu/s390-*.img*
      - share/qemu/slof.bin*
      - share/qemu/vgabios-*.bin*

  qemu-ovmf-secureboot:
    build-attributes: [core22-step-dependencies]
    after:
      - edk2
      - qemu
    source: https://github.com/puiterwijk/qemu-ovmf-secureboot
    source-type: git
    source-depth: 1
    plugin: nil
    build-packages:
      - xorriso
    override-build: |-
      [ "$(uname -m)" != "x86_64" ] && [ "$(uname -m)" != "aarch64" ] && exit 0

      export ARCH="$(basename $(readlink -f ${SNAPCRAFT_STAGE}/lib/*-linux-gnu*/))"
      export LD_LIBRARY_PATH="${SNAPCRAFT_STAGE}/lib:${SNAPCRAFT_STAGE}/lib/${ARCH}"

      set -ex
      rm -Rf iso-root vfat-root shell.iso
      mkdir -p iso-root vfat-root/efi/boot
      cp ../../edk2/build/Build/*/*/*/Shell.efi vfat-root/efi/boot/bootx64.efi
      cp ../../edk2/build/Build/*/*/*/EnrollDefaultKeys.efi vfat-root/
      "${SNAPCRAFT_STAGE}/bin/qemu-img" convert --image-opts driver=vvfat,floppy=on,fat-type=12,label=UEFI_SHELL,dir=vfat-root iso-root/shell.img
      xorriso --as mkisofs -input-charset ASCII -J -rational-rock -e shell.img -no-emul-boot -o shell.iso iso-root/

      # Basic aarch64 support
      if [ "$(uname -m)" = "aarch64" ]; then
          sed -i ovmf-vars-generator \
              -e "s/'-machine', machinetype,/'-machine', 'virt', '-cpu', 'cortex-a57',/" \
              -e "/charserial1/d" \
              -e "s/ide-cd/scsi-cd/" \
              -e "s/'-device',$/'-device', 'virtio-scsi-pci,id=scsi', '-device',/"
      elif [ "$(uname -m)" = "x86_64" ]; then
          cp -f "${SNAPCRAFT_STAGE}/share/qemu/kvmvapic.bin" .
      fi

      mkdir -p "${SNAPCRAFT_PART_INSTALL}/share/qemu/"
      python3 ovmf-vars-generator \
        --qemu-binary "${SNAPCRAFT_STAGE}/bin/qemu-system-$(uname -m)" \
        --print-output --disable-smm --skip-testing \
        --oem-string "$(cat ${SNAPCRAFT_PROJECT_DIR}/snapcraft/etc/ubuntu-sb.crt)" \
        --ovmf-binary "${SNAPCRAFT_STAGE}/share/qemu/OVMF_CODE.fd" \
        --ovmf-template-vars "${SNAPCRAFT_STAGE}/share/qemu/OVMF_VARS.fd" \
        --uefi-shell-iso shell.iso \
        "${SNAPCRAFT_PART_INSTALL}/share/qemu/OVMF_VARS.ms.fd"
    prime:
      - share/qemu/*

  raft:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/canonical/raft
    source-type: git
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    stage-packages:
      - libuv1
      - liblz4-1
    build-packages:
      - libuv1-dev
      - liblz4-dev
    organize:
      usr/lib/: lib/
    prime:
      - lib/libraft*so*
      - lib/*/libuv.so*

  sqlite:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/sqlite/sqlite
    source-type: git
    source-depth: 1
    source-tag: version-3.39.2
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    build-packages:
      - tcl
    prime:
      - bin/sqlite3
      - lib/libsqlite3*so*

  squashfs-tools-ng:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/AgentD/squashfs-tools-ng
    source-type: git
    source-tag: v1.1.4
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=
    build-packages:
      - liblzma-dev
    prime:
      - bin/sqfs2tar
      - bin/tar2sqfs
      - lib/libsquashfs.so*

  vim:
    build-attributes: [core22-step-dependencies]
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - vim-common
      - vim-tiny
    organize:
      usr/bin/: bin/
      usr/share/vim/vim*/debian.vim: etc/vimrc
    prime:
      - bin/vim.tiny
      - etc/vimrc

  xfs:
    build-attributes: [core22-step-dependencies]
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xfsprogs
    organize:
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/xfs_admin
      - bin/xfs_db
      - bin/xfs_growfs
      - bin/xfs_repair
      - bin/mkfs.xfs

  xtables:
    build-attributes: [core22-step-dependencies]
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - arptables
      - ebtables
    organize:
      usr/lib/ebtables/: lib/
      usr/sbin/: bin/
    prime:
      - bin/arptables-legacy
      - bin/ebtables-legacy
      - etc/ethertypes
      - etc/protocols
      - lib/libebtc.so.*

  xz:
    build-attributes: [core22-step-dependencies]
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - xz-utils
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/sbin/: bin/
    prime:
      - bin/lzma
      - bin/xz
      - lib/*/liblzma*so*
    override-build: |
      snapcraftctl build

      # Include the lzma symlink
      ln -s xz "${SNAPCRAFT_PART_INSTALL}/usr/bin/lzma"

  zfs-0-6:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.6.5.11
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick fb963d33ee0dd350143ba1c9cd35d5f7d86910d2  # Fix endian build problem on ppc64el

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.6/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-7:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.7.13
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - libblkid-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.7/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-0-8:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-0.8.6
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-0.8/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-2-0:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-2.0.7
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-2.0/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"

  zfs-2-1:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/openzfs/zfs
    source-type: git
    source-tag: zfs-2.1.5
    source-depth: 1
    plugin: autotools
    autotools-configure-parameters:
      - --prefix=/
      - --with-config=user
    build-packages:
      - libblkid-dev
      - libssl-dev
      - uuid-dev
      - zlib1g-dev
    override-build: |
      set -ex

      [ "$(uname -m)" != "x86_64" ] && \
        [ "$(uname -m)" != "aarch64" ] && \
        [ "$(uname -m)" != "s390x" ] && \
        [ "$(uname -m)" != "ppc64le" ] && exit 0

      set +ex
      snapcraftctl build
      set -ex

      mv "${SNAPCRAFT_PART_INSTALL}" "${SNAPCRAFT_PART_INSTALL}.tmp"
      mkdir -p "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/bin" "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/lib"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zfs" "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/sbin/zpool" "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/udev/zvol_id" "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/bin/"
      mv "${SNAPCRAFT_PART_INSTALL}.tmp/lib/"*so* "${SNAPCRAFT_PART_INSTALL}/zfs-2.1/lib/"
      rm -Rf "${SNAPCRAFT_PART_INSTALL}.tmp"


  zstd:
    build-attributes: [core22-step-dependencies]
    source: snapcraft/empty
    plugin: nil
    stage-packages:
      - zstd
    organize:
      usr/bin/: bin/
    prime:
      - bin/pzstd
      - bin/zstd

  # Core components
  lxc:
    build-attributes: [core22-step-dependencies]
    after:
      - libseccomp
    source: https://github.com/lxc/lxc
    source-type: git
    source-tag: lxc-5.0.1
    build-packages:
      - libapparmor-dev
      - libcap-dev
      - libgnutls28-dev
      - libselinux1-dev
      - pkg-config
    plugin: meson
    meson-parameters:
      - --prefix=/
      - -Dexamples=false
      - -Dman=false
      - -Dtools=false
      - -Dtests=false
      - -Dmemfd-rexec=false
      - -Dapparmor=true
      - -Dseccomp=true
      - -Dselinux=true
      - -Dcapabilities=true
      - -Drootfs-mount-path=/var/snap/lxd/common/lxc/
      - -Dlibexecdir=/snap/lxd/current/libexec/
    organize:
      snap/lxd/current/lxc: lxc
      snap/lxd/current/libexec: libexec
      share/lxc/hooks: lxc/hooks
    prime:
      - bin/lxc-checkconfig
      - lib/*/liblxc.so.1
      - lib/*/liblxc.so.1.*
      - lxc/config/common.conf.d
      - lxc/hooks/nvidia
    override-build: |
      set -ex

      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      cd ../build

      set +ex
      snapcraftctl build
      set -ex

      mkdir -p $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/
      ln -s /var/snap/lxd/common/lxc/local.conf $SNAPCRAFT_PART_INSTALL/lxc/config/common.conf.d/01-local.conf

  lxcfs:
    source: https://github.com/lxc/lxcfs
    source-type: git
    source-tag: lxcfs-5.0.1
    build-packages:
      - libfuse-dev
      - libpam0g-dev
      - pkg-config
      - python3-jinja2
    stage-packages:
      - fuse
    plugin: meson
    meson-parameters:
      - --prefix=/
      - --datadir=/snap/lxd/current/
      - --localstatedir=/var/snap/lxd/common/var/
      - -Ddocs=false
      - -Dtests=false
    organize:
      lib/*/lxcfs/liblxcfs.so: lib/
      snap/lxd/current/lxc/config/common.conf.d/*: lxc/config/common.conf.d/
      snap/lxd/current/lxcfs/: lxcfs/
    prime:
      - bin/fusermount
      - lib/*/libfuse.so.*

      - bin/lxcfs
      - lib/liblxcfs.so

      - lxc/config/common.conf.d/00-lxcfs.conf
      - lxcfs/
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      set +ex
      snapcraftctl build
      set -ex

      patch -p1 $SNAPCRAFT_PART_INSTALL/snap/lxd/current/lxcfs/lxc.mount.hook < "${SNAPCRAFT_PROJECT_DIR}/patches/lxcfs-0001-hook.patch"

  lxd:
    build-attributes: [core22-step-dependencies]
    source: https://github.com/lxc/lxd
    source-type: git
    source-tag: lxd-5.0.0
    after:
      - lxc
      - dqlite
      - sqlite
    build-packages:
      - libacl1-dev
      - libudev-dev
      - pkg-config
    build-snaps:
      - go
    stage-packages:
      - acl
      - attr
      - dnsmasq-base
      - gdisk
      - iw
      - netbase
      - pciutils
      - pigz
      - rsync
      - squashfs-tools
      - usbutils
      - xdelta3
    plugin: nil
    override-pull: |
      snapcraftctl pull
      set -ex

      # Setup build environment
      export GOPATH=$(realpath ./.go)

      # Setup the GOPATH
      rm -Rf "${GOPATH}"
      mkdir -p "${GOPATH}/src/github.com/lxc"
      ln -s "$(pwd)" "${GOPATH}/src/github.com/lxc/lxd"

      # Download the dependencies
      go get -d -v ./...
    override-build: |
      set -ex

      # Git cherry-picks
      cd ../src
      git config user.email "noreply@linuxcontainers.org"
      git config user.name "LXD snap builder"

      git cherry-pick 132dc99478619f8154da7237b876d4d902cac142  # doc: move networking content to new files
      git cherry-pick 8be9eb4e50a51f6d4fdab674d1b8646af79ef0bb  # doc: add new files to the networking docs
      git cherry-pick 05ed3f422ef036853265a204a575e174a5a0f908  # doc: move network-peers
      git cherry-pick eecf1700b2a07c32984de7c34b4051f42cc6b2df  # doc: move network-acls
      git cherry-pick a542fb4c30754476240b08046a127e31487146b8  # doc: move network-forwards
      git cherry-pick 6f157fcf82d27c46694cf61f3c6f1780027a17bd  # doc: move network-zones
      git cherry-pick f6de27bd3bc1e7171d1655056361bc4be5076c55  # doc: clean up headings for networking section
      git cherry-pick 3fcc17206e9bdb3ba684b781085431df934fa7ae  # doc: update and add content for networking
      git cherry-pick ffab05757c489fcd706f462f42f655752940e665  # doc: add links to network_ovn_peers
      git cherry-pick a2344e60d953519ea8c73c60afdee44f4d2ea24a  # doc: add links to network_zones
      git cherry-pick a51b7ff9ecb6a20f6cc8068dc894471707e65d68  # doc: add links to network_forwards
      git cherry-pick 989824a9e0a0879e8cadf2e96f1f73badbbcba4d  # doc: add links to network_acls
      git cherry-pick 5329cf16a773d4ad766f09e504a118322e2345a2  # doc: general cleanup
      git cherry-pick 9307ef7172e1eb3c0d99ff05dea9c1da48da1a37  # doc: general cleanup network_acls
      git cherry-pick d1c65d4d61270e27aeca61587da74f65163870a3  # doc: general cleanup network_forwards
      git cherry-pick 41fca2d8509a1067856bfa06f01689e3b970f524  # doc: general cleanup network_zones
      git cherry-pick 1b153b5e16eb5aba470653ebba29e94c98d9d61c  # lxd/storage/btrfs: Fix usage nested
      git cherry-pick 160ade378c7107b127e963bba186522f5c0ace27  # lxd/instance/qemu: Fix bad topoext logic
      git cherry-pick 261429cdccc9d90fc34b513619f44872d0cc9da9  # lxc: Fix typo in notes
      git cherry-pick 6516c04e8bb0ba58e0757073c26d7d213fccb674  # lxd/networks: Removes references to nodes in user facing errors
      git cherry-pick dc356a0d21799b54b9a811eb8afe2ff7d9c11914  # lxd/networks: Clone per-node config on networksPostCluster
      git cherry-pick 6c381980e3d028e270a0186883d2902c6db5d436  # lxd/storage/pools: Removes references to nodes in user facing errors
      git cherry-pick ab9d53116f364466b564bf381e7c61d6387fa2b0  # lxd/db/storage/pools: Renames StoragePoolNodeConfigKeys to NodeSpecificStorageConfig
      git cherry-pick cbeefde48902ce43ed697f1694333fedc1c16179  # lxd: db.NodeSpecificStorageConfig usage
      git cherry-pick 75618b0a3f94f8c59560b0812d3de8d2c270f2c9  # lxd/cluster/config: Remove legacy server level storage settings defaults
      git cherry-pick e68635fbbeec6bba76092d624eb3721c2b4aa69c  # lxd/cluster/config: Remove deprecatedStorage
      git cherry-pick 2f9074e43cc865ecf670701627970ebfacda8565  # lxd/storage/utils: Removes ValidName
      git cherry-pick 95604e00aa88a2ab191a3c82be1b5faecf9fab10  # lxd/storage/pool/interface: Adds Type interface
      git cherry-pick de6acfdec8346796a10bf9ebb21ed6dcc431961c  # lxd/storage/pool/load: Adds LoadByType function
      git cherry-pick 0938b547e375d0a6a2e2542663ba310a53fc8650  # lxd/storage/backend/mock: Adds ValidateName function
      git cherry-pick 08583cb46b91fd4af16c3c9e0b4971115457b709  # lxd/storage/backend/lxd: Adds ValidateName function
      git cherry-pick 1bc5ddffdd05f8ee2f37add815e7863dedcc247d  # lxd/storage/utils: Improve validation of rsync.bwlimit
      git cherry-pick 337ceae14501272c683f18ed4a158b7943a0b3ac  # lxd/storage/backend/lxd: Validate earlier in Create
      git cherry-pick f22e2fbb72a9ccb31e68b0e403c22d9b8094be29  # lxd/storage/pools/utils: Updates storagePoolValidate to use poolType.ValidateName
      git cherry-pick f02da484fdac5bb2272f7bfef79caa4d72ebf581  # lxd/storage/volumes/snapshot: Updates storagePoolVolumeSnapshotsTypePost to use pool.ValidateName
      git cherry-pick 81e83b381d319f01f04984a9e6316ff866251306  # lxd/storage/utils: Unexport some variables now unused outside of storage package
      git cherry-pick 6afa2bc4989898d0f9807f3cb23afbf5626ccfcf  # lxd/storage/pool/interface: Adds Validate signature
      git cherry-pick bea96ed8fe72ac6084390dd70b3bed1bf2e141d6  # lxd/storage/backend/lxd: Adds Validate function
      git cherry-pick 998d0df0f42fb06c9da8445cdf8b585175f9fa47  # lxd/storage/backend/mock: Adds Validate function
      git cherry-pick c1b97ae5fe7311260f51dc037b99dc975a19cf46  # lxd/storage/backend/lxd: Call b.ValidateName in Create
      git cherry-pick 741cfb63bf5509cad30d7418fe3751735b501312  # lxd/storage: size is not a common pool option
      git cherry-pick c5400c9dc9f63716469d52e0bf343f8a3f7155e7  # lxd/storage/drivers/driver/common: Removes pool name from validatePool errors
      git cherry-pick d99d0e2e1f01b0d122c03a5126274d321c68cca0  # lxd/storage/pools: Don't call storagePoolValidate from storagePoolsPostCluster
      git cherry-pick 7cef8d28fe6926dec80b83da80b5ff5abc079428  # lxd/storage/pools: Call pool.Validate directly in doStoragePoolUpdate
      git cherry-pick 75f6b4f751eaede108427e4a8e2afd38adcf5500  # lxd/storage/pools/utils: Call poolType.Validate in storagePoolValidate
      git cherry-pick b995ed80791302f3ecacca6d5a7d35a89799ab2f  # lxd/storage/pools/config: Remove legacy storagePoolConfigKeys and storagePoolValidateConfig
      git cherry-pick 12875d4a061de0d77135eb66a5e71cc44f44e6d7  # lxd/storage/pools: Clone per-node config in storagePoolsPostCluster
      git cherry-pick 92b46d0bc335360891df555574541cd576fac701  # lxd/storage/pools/utils: Whitespace in storagePoolDBCreate
      git cherry-pick 5b19cf5da0df0ad5df482d87f627586442682db2  # lxd/storage/pools/utils: Expand arg types to storagePoolDBCreate
      git cherry-pick d1a8a7d178025b0255b506b5208b39f42c31370d  # lxd/storage/pools/utils: Use revert in storagePoolCreateGlobal
      git cherry-pick 66931533d8f42aed8fbd7af9182d63f7eb09d00a  # lxd/storage/pools/config: Remove file
      git cherry-pick c816af1344277ddb011a57ac9bb7aaf4e78e459f  # lxd/storage/pools/utils: Removes call to storagePoolFillDefault in storagePoolDBCreate
      git cherry-pick ea760f62ce99a574aa44e6f666fb875ec03e6fb8  # lxd/storage/pools/utils: Rely on pool.Create to fill default pool config in storagePoolCreateLocal
      git cherry-pick 10aa0f2d08a85ec1c5d25b73c2cd3ca8ce30b0d2  # lxd/storage/drivers/utils: Adds loopFileSizeDefault function
      git cherry-pick 8e4d44c4b63b52ef03e81e825c6aa5b1f189c657  # lxd/storage/drivers: Generate per-node loop file size from loopFileSizeDefault in Create
      git cherry-pick 92bbb47a791588cf1b9d936fddaff6530c67014b  # lxd/storage/drivers/driver/lvm/utils: Adds lvmThinpoolDefaultName constant
      git cherry-pick a3851548aa1afa4b96ee711f7d12063c18510832  # lxd/storage/drivers/driver/lvm: Populate lvm.thinpool_name if not specified in Create
      git cherry-pick 1da1b81639c6552285b18fcb961db387e806165d  # lxd/storage/utils: Removes unused functions and variables
      git cherry-pick 8a9f74647921efc18f8f70b02ef36f8d23b3ae62  # lxd/storage/pool/load: Removes unused CreatePool function
      git cherry-pick 0d25b81d6757646214dd86352d10239d4142eaca  # lxd: Fix typo in notes
      git cherry-pick 7350c0a9fde94fffeb82d733f32025a176aaae1d  # doc/rest-api: Refresh swagger YAML
      git cherry-pick 28d3366760f72f33a46725321cc63fb7097cd9c7  # shared: Adds method to remove elements from a slice.
      git cherry-pick 632000dfb91fa3c5203172b77f4a65b97d143c63  # lxc: Adds cluster role <add>/<remove> commands.
      git cherry-pick b7e998d20ba4e7daac84feceec83f0cc9593ff09  # i18n: Update translation templates.
      git cherry-pick 88011c17d303a2e017cb38bd5dcf18bd19459eea  # test: Removes cluster edit <stdin> where possible.
      git cherry-pick b69787c07ae7dad2d1d1a4a3af9d549eefcf7b77  # lxd/db/generate/db/method/v2: Add V2 method generation
      git cherry-pick b2155ad03efd7e08dcc7fe8bf46a13fc44d4e631  # lxd/db/certificate/projects.mapper: Update generated code
      git cherry-pick 90c5aa74c2177e0c3076e929f75ab55cb224de8f  # lxd/db/certificates: Remove Projects from db Certificate struct
      git cherry-pick 5175347b64cf77411eff8ee16dd0c6bed7f34cdd  # lxd/db/certificates.mapper: Update generated code
      git cherry-pick 063683a48df3b1c156955f97e0421e27825a9349  # lxd/db: Use ClusterTx with ToAPI for filling reference fields
      git cherry-pick 12e5f9dafc80a93978016e812846b3be0659d17d  # lxd/db/certificates: Pass projects into create/update helpers
      git cherry-pick 65bd21a6be2dfc7c366f6ca61b5f861d4b39dd61  # lxd/db/certificates: Transition to using ClusterTx
      git cherry-pick acaa33da6fcf6a992ba6ebbcd5d7fb70df1d9e1f  # lxd/events: Use ClusterTx instead of opening new transactions
      git cherry-pick 91f7ab7a3f2a47a1090a80d17c3765a62d77587d  # lxd/certificates: Open fewer txes, use API structs for all fields
      git cherry-pick 5754859ed0c93f65cd5a443f840209793b3d3bf6  # lxd/api/cluster: Update cert projects manually
      git cherry-pick 93f9bf4e9edfd6d7c758ee1a5a3a34b6a308d34d  # lxd/instance/drivers/qemu: Add serial key to device
      git cherry-pick 28b5db5b90ed65f3669e0e605a2c2114c41f140c  # shared: Add SplitNTrimSpace
      git cherry-pick 4cc82e4025426e677db942b77b857a54b846d6c9  # lxc: Move to shared.SplitNTrimSpace
      git cherry-pick a5d78befcb26254a689fe4085e26f71ffe896ddd  # lxd: Move to shared.SplitNTrimSpace
      git cherry-pick 8a0cfbc961dcc34ac52bae1debfab8423b9b5a20  # lxd/util: Remove SplitNTrimSpace
      git cherry-pick 1a1983f7a561b58301c7d1199c81433b59e41bf1  # lxd/cluster: Don't overwrite original volatile.evacuate.origin
      git cherry-pick 1ee5b49d4bcb91704908820587ac747c53a82927  # lxd/daemon/images: Renames imageDownloadLock to imageOperationLock
      git cherry-pick 1790ddf5e2aaef1de5eb27b6bd6b5d7885a208de  # lxd/images: Use SmartError when handling error from d.cluster.GetImage
      git cherry-pick 7e51cb87624f11690432a6741a522c62a1d52a34  # lxd/images: Use imageID rather than imageId
      git cherry-pick c82f2f9b0b9e41594e0bb8444fa1f9ce0fb0cef9  # lxd/images: Add locking on imageDelete
      git cherry-pick 8682817f047b2b3c4fe3706f4dba8f57f1905b3c  # lxd/db/generate: Replace ErrNoSuchObject with api.StatusErrorf(http.StatusNotFound)
      git cherry-pick 1abd7601af4e8207fe19d9cb5b3150fdf63552cb  # lxd/db: Applies changes to db generator
      git cherry-pick f1d673f48ed0b16ef9d747692d0b24213fefad3e  # lxd/util/net: Assign default port if no port given
      git cherry-pick 3c4d2abd250f04cdca7b70930ab664d086163afa  # lxd/instance/qemu: Allow using external firmware or kernel
      git cherry-pick d2c990ca63f035f87c0639fd6cb29ec1fa2e4016  # lxd/instance/drivers: Fix context logging
      git cherry-pick d5193515e665f2350d1ae0ff944b56017755cc78  # lxd/storage/utils: Use volName in context logging for consistency
      git cherry-pick 6605bf934621b0f54298d669b07b4f04132b4103  # lxd/storage/volumes/snapshots: Use volName in context logging for consistency
      git cherry-pick a07744614bc8dedebf0c70194808aca8d90622c7  # lxd/storage/drivers/driver/ceph/utils: Use volName in context logging for consistency
      git cherry-pick 5bb710eca232f6ab35520754bb8367d4c1fda342  # lxd/storage/drivers/driver/lvm/volumes: Remove non-thinpool volume activation/deactivation workarounds
      git cherry-pick 22fa7183d6c61ca9be131490d78c7459ba736264  # lxd/storage/drivers/driver/lvm/utils: Updates activateVolume and deactivateVolume to accept Volume type
      git cherry-pick cfd3d5d5a7e33cfc314d3131f31f82310df92980  # lxd/storage/drivers/driver/lvm: activateVolume and deactivateVolume usage
      git cherry-pick d72221c6b23458d8f635b56bb54b85bea316cd5d  # lxd/storage/drivers/generic/vfs: Check for close errors
      git cherry-pick 23d7b5155032c4b125b104578f9aa672ad912d72  # shared/instancewriter/instance/tar/writer: Check for close errors
      git cherry-pick db7a7aca373c0ccfc7e484f027130953d62e1c1e  # doc: move Sphinx extensions to a separate repo
      git cherry-pick fdddb35a8d928419d01a6b179119aef8e2c26b13  # lxd/storage/drivers/volume: Check for unmount errors in MountTask
      git cherry-pick 628f64265e6fb9b73aec50e3b22ad731db253fa7  # lxd/device/device/utils/disk: Use storageDrivers.TryUnmount without MNT_DETACH in DiskMountClear
      git cherry-pick 71a2224ed95aee7a968514d254b17b76c57db005  # doc: whitespace changes and reordering content
      git cherry-pick 11e669b5f2b43a84ccd488c6b1c62c73067f6a45  # doc: add headings
      git cherry-pick 21b8831112b66414799dd28608edebb984d3d5b3  # lxd/storage/drivers/utils: Adds debug logging to TryUnmount
      git cherry-pick 2b9ade530105f9984644146d2679fb083dfc0962  # lxd/instance/qemu: Tweak warning on -bios/-kernel
      git cherry-pick e72f7ff30ef450f7a00f53d689873fbaa0d67be3  # lxd/storage/drivers/driver/lvm/utils: Don't deactivate non-thinpool snapshot volume if parent mounted
      git cherry-pick 16613201f7d2d42d6517272a14edda84b39e52cf  # test: Removes old storage pool driver exclusions
      git cherry-pick 07dc796e94e1b2fe66cf60bebff726ba8b6148bc  # lxd/storage/drivers/generic/vfs: Detect close errors in genericVFSMigrateVolume
      git cherry-pick 678d576f8bc85342b53a92c6f12299aadc858651  # lxd/instance: Fix RuntimeLiblxcVersionAtLeast to handle ~
      git cherry-pick 8f18828c18b1ad34abe3ed2979248fa2c306485d  # shared: allow EOPNOTSUPP from llistxattr()
      git cherry-pick f7af54edfbbefd847551143e6db202b620e3c60c  # doc: update BGP server documentation
      git cherry-pick f589a2a79b5f2d7e22de6cb2e4dd576243621506  # lxd/instance/drivers/driver/qemu: Correctly detect dish source path filesystem
      git cherry-pick 724376272232da3451a1ed097b437ac41b8e206a  # lxd/instance/drivers/driver/qemu: Improve disk error context and comments
      git cherry-pick 68e5a14a0fc8bcba458a435b926783e27bf846a7  # lxd/instance/drivers/driver/qemu: Fixes incorrect FD garbage collection in addDriveConfig
      git cherry-pick 9c3fd122c9ad8467190a3f1c401171366d1006d0  # lxd/instance/drivers/driver/qemu: Remove unnecessary duplicated stat of disk source
      git cherry-pick 9c88aaf31471d81bf3334aa17b1ed074a0abf956  # lxd/instance/drivers/driver/qemu: Add input checks to addDriveConfig
      git cherry-pick 6722f7b9c9b3e3a15cdd9e40b1d24bb7391ac22e  # lxd/device/disk: Pass cloud-init:config drive to QEMU using file descriptor
      git cherry-pick 2740949ca7a52d05b31f780735550adf9d805559  # lxd/device/disk: Return explicit nil on error in localSourceOpen
      git cherry-pick 5db4b40402f40365b7239ffa9284d36ae1dc85c8  # test/suites/migration: Check optimized refresh
      git cherry-pick a45ee33d04301b436164c6581aae71700707c1f5  # lxd/storage/drivers/btrfs: Change how subvolumes are received
      git cherry-pick f0d9658f80f160008e9895e1fec2692b712d6604  # lxd/storage/drivers/btrfs: Move subvolumes after reception
      git cherry-pick f53f7ae1dadb9c9c9cd3ee07e394c19f08256cad  # lxd/storage/drivers/btrfs: Update CreateVolumeFromBackup
      git cherry-pick bcd94d75c8524fd6c6eec5b5d780eb394e0b0a9c  # lxd/instance/operationlock: Add update
      git cherry-pick 4ec4d1e50d77ead2c0bd088e747ddafead38e09f  # lxd/instance/lxc: Use locking in Update
      git cherry-pick b20f0fb570f8ff58753c9e6b1a1bf3da35c2ce68  # lxd/instance/qemu: Use locking in Update
      git cherry-pick 43ce2e214fc9d8eca44ee336288d17819765d92c  # lxd/instance/qemu: Replace container with instance
      git cherry-pick 2c1e4241b4c4c6555dc99f16991bfcab8bcd6752  # lxd/instance: Reword operationlock errors
      git cherry-pick bb9ab659397c5a8af17e901d7b90e173e2cce865  # lxd/migration/wsproto: Check websocket argument
      git cherry-pick 5d02b7bf222d76ad64037d126f7ef2ca87bb3a80  # lxd/storage/backend: Fix VolumeDBDelete revert
      git cherry-pick 460e177534582c94a0df2fb9a5974a2994288cec  # lxd/cluster: fix typo in comment
      git cherry-pick bc597b07617ca4900ad1677ee2180a4de6edb4ca  # test/includes: remove unnessary subshells
      git cherry-pick 55ae69f6fa08de68390e9051c9a9b391e6333b2a  # lxd/api/cluster: Remove duplicated not found error handling
      git cherry-pick 6103d13e592477935e41378874a71930a4d2aafb  # lxd/api: Update not found error matching
      git cherry-pick ce7b3fb2692765c26520a46ea0b91872ca0a7ede  # lxd/db: Replaces use of ErrNoSuchObject with api.StatusErrorf(http.StatusNotFound)
      git cherry-pick fd8d5a0903df0ffc5d4e470b4d4dc2b75c6825ae  # lxd/db/errors: Removes ErrNoSuchObject constant
      git cherry-pick d5f8f79cc1323139c97e30ca99e437994d1fc82c  # lxd/db: Don't use "node" in user facing errors
      git cherry-pick ab2ad76d4abfd39de0a76895b33a3057f0ab1403  # lxd/db/network/zones: Fix query case in GetNetworkZone
      git cherry-pick 51c7f398c813196449aba380364f0626b24aa5c9  # lxd/operations: Replace use of db.ErrNoSuchObject with api.StatusErrorf(http.StatusNotFound)
      git cherry-pick d734e0bd90e9ba1ef9d61556d1198f3f705f071f  # lxd/response/smart: Remove db.ErrNoSuchObject use
      git cherry-pick 214374e9584ffedd17c9f4cee52fc87b5c919d8b  # lxd/storage/drivers/driver/ceph: Replaces use of db.ErrNoSuchObject with  api.StatusErrorf(http.StatusNotFound)
      git cherry-pick abd83fe48a764bf821460ac66ffa889a6c44ea49  # lxd/storage/drivers/lvm: Replaces use of errLVMNotFound with api.StatusErrorf(http.StatusNotFound)
      git cherry-pick 785bcf974e6dd98f5d3f430f1afe1430b4ef66ac  # lxd/backup/backup/config: Default to container instance type if not specified in backup config
      git cherry-pick 454d593d26ab6e2258f0157f60f659302328e4ff  # test: Update backup test error response checks
      git cherry-pick c10501ca620975272c9a557fb96e806fab98d00f  # lxd/storage/drivers/zfs: Close stderr after copy
      git cherry-pick 2945b6c43770140224f09eb7f549b96919884a37  # doc: order tables alphabetically
      git cherry-pick 074f07961817b3453545d8131bb799c48570d020  # doc: add IDs for easier linking
      git cherry-pick a8c3c9a6210182d260edba58efcc3385c2fc2fc4  # doc: move content to different files and include
      git cherry-pick a15b3da3bf0def9295cdf0b3c337e1a88e730a30  # doc/network/bridge: move IPv6 prefix section
      git cherry-pick 9e0a6d29061018920ae043737ba07ad07ee4b9e7  # doc/network/bridge: make config table for network_bridge consistent
      git cherry-pick 759c352eeb08ba73cef33b379de2d3d4509910d8  # doc/network/ovn: make config table for network_ovn consistent
      git cherry-pick 8a9930902c8ddf002300b2dd8acd891043c99614  # doc/network/macvlan: make config table for network_macvlan consistent
      git cherry-pick 254064ac57c5786a17eaaaedc4489e11bd0ce04e  # doc/network/physical: make config table for network_physical consistent
      git cherry-pick 6037ac9a9e1be92dfac3f9edd2c86ad7f21a468a  # doc/network/sriov: make config table for network_sriov consistent
      git cherry-pick 76b49b77bab056b18cc15c2e90ef33fc178bce1e  # doc: add a reusable note about IP address format
      git cherry-pick 490c03af6b455163eb8fb2af454840b0d22fea70  # doc/network/bridge: add name space and format information for table
      git cherry-pick c0e73415c2df67db335a3df453620582d03765c0  # doc/network/physical: add name space and format information for table
      git cherry-pick f27fefc33952b1653004e4a89efb646fe134606c  # doc/network/ovn: add name space and format information for table
      git cherry-pick 146834e12fe6788029fd8fc5a514e6f429f0757c  # doc/network/macvlan: add name space and format information for table
      git cherry-pick ee3a8acbd8bc7c0b82a5a37da21d5f2ef7358bd1  # doc/network/sriov: add name space and format information for table
      git cherry-pick 8d45f691a6871907388cb29a421b805045595c55  # doc/network/physical: add supported features for network_physical
      git cherry-pick bfe54110f20e6e5e77d0de68f3f8e0235927da6c  # doc/network/ovn: add supported features for network_ovn and hide ToC
      git cherry-pick 94f69317d38b9e4478f9879015819e5416b16c48  # doc/network/bridge: add supported features for network_bridge and hide ToC
      git cherry-pick d9ecdd3bf01b3f901e4554db89e5d8f4d5f5877a  # doc/network/bridge: content updates network_bridge
      git cherry-pick b471bcb499dc37e4c379cc8a7b66415631440ce2  # doc/network/ovn: content updates network_ovn
      git cherry-pick e96214da9efdf427c769893e5949d9f4c564d0c7  # doc/network/physical: content updates network_physical
      git cherry-pick 4e8b09d6d3449b2acc80c9db0e1b495ae7aaac3b  # doc/network/sriov: content updates network_sriov
      git cherry-pick 7b61322c1d1e1f45ca2affb05a452cac4ef22598  # doc/network/macvlan: content updates network_macvlan
      git cherry-pick 40f16df25f919aacb294f638c4c37a76509268fe  # doc/network/external: content updates network_external
      git cherry-pick 4760237f6848a92f6bd2296a966a65fa76dfec95  # global: Update doc links to /latest
      git cherry-pick 4697866eac94c0c65ba1a752056a4aade2fe9bef  # README: Use links to public doc pages
      git cherry-pick f724f72cf10427f53299f7397373d92e53670c67  # CONTRIBUTING: Use links to public doc pages
      git cherry-pick 61d39128814c708c6fe6af02f503bad113a036c5  # lxd/storage/drivers/generic/vfs: Updates genericVFSCopyVolume to not copy block volume files twice
      git cherry-pick dbf307e2c0d2e52d7094115f3408c49cb11081af  # lxd/storage/drivers/driver/dir/volumes: Use reverter in CreateVolumeSnapshot
      git cherry-pick 25b1e25be0d21b07dbd146e19d3165bcede99411  # lxd/storage/drivers/utils: copyDevice arg type expansion
      git cherry-pick e1e4be9151d70f270ffc2d01fd971df27c9e1acc  # lxd/storage/drivers/utils: Catch file close errors in copyDevice
      git cherry-pick dd00a1212a2e7620f681c72a1d09b43d8161fbea  # lxd/fsmonitor: Hide permission errors
      git cherry-pick ef29da97c5383762e868d604a6ba7d72d24a8f17  # lxd/instance/lxc: Better handle missing apparmor
      git cherry-pick 5ccd6eb2b419571434ea8e6fb4a3387d540bd6df  # lxd/apparmor/dnsmasq: Support non-snap nesting
      git cherry-pick e554804b69482436fc3396a0cb2e02d2f155c9fe  # lxd/apparmor/dnsmasq: Properly handle logpath
      git cherry-pick 44ef838e89ff21cf81cd24482194ba00a5b8f7df  # lxd/instance/qemu: Avoid conflicting vsock IDs
      git cherry-pick 69cb7e3942b6ec15a4ac19d3011652a37b2eb7fd  # lxd/storage/drivers/driver/dir/volumes: Updates CreateVolumeSnapshot to copy block volumes using io.Copy
      git cherry-pick 4b3b0a3acbe9dd0deb45c089985affc2539059d0  # lxd/storage/backend/lxd: Create instance snapshot symlink in CreateInstanceFromCopy
      git cherry-pick bc8334e0f6cb63d35f514147b9efabc61e41a45f  # lxd/storage/drivers/utils: Update copyDevice to use low priority dd with 16M byte size and direct i/o
      git cherry-pick 4b984c14e245de6bb49ee5f802af694cbe912467  # lxd: No need to import deprecated syscall
      git cherry-pick d5f3d0cd602dd4d55dd4f89e4fd70d8eb5a4bccc  # lxd/storage/utils: Run qemu-img dd with low priority and 16M buffer
      git cherry-pick a3b568bad94b27771f4843439d270569dbde3d89  # lxd/instance/drivers/driver/qemu: Run qemu-img with low priority in Export
      git cherry-pick 01ef3aad0ae4e50be98444e05b36f3d8f4186dbd  # lxd: Error quoting fixes
      git cherry-pick 09f47e0bf8d5eb3845da0ad828b2de6019d1d4d1  # lxd: Use SmartError rather than NotFound
      git cherry-pick 6fee3b624d3adbda4d07c24bd8d143abca2f96c9  # lxd/networks: Don't return os.ErrNotExist from doNetworkGet
      git cherry-pick 32b92f6f6ff138de1845cfa6c1cdcaf9fa7fe7ed  # test: drop dependency on uuidgen
      git cherry-pick 0d831e51e967dfa6a462cf6f562158cf7eb29026  # lxd-agent: Ignore both trans= and msize= when on virtiofs
      git cherry-pick b27d541f0997358b571ac2840f86660d55c9130c  # lxd/instance/qemu: Set msize on 9p
      git cherry-pick 43c9ab57470f9331c61ec34ae967535d01dede6e  # lxd/main_forkfile: Update comment
      git cherry-pick d88054b8f18db4fc210904134848ce0c54ae0bfa  # shared/idmap: Expose IdmapSet on all platforms
      git cherry-pick 8604637ed68799dd7c2a8b93748adbba8fcc4e61  # shared/subprocess: Add SetUserns
      git cherry-pick ebae6babd733b442ed3bacb47614006fd24d2f16  # lxd/device/disk: Port to SetUserns
      git cherry-pick 22ec0b8594bee8d13f1f26500c9e2f7d82e6167e  # lxd: Remove forkuserns
      git cherry-pick ce9365f5cd29db77a655767d7b600a5182b89ecb  # global: Remove legacy build tags
      git cherry-pick eff59c0bbda054488a22b0ab9cb16e865b7043db  # lxd/instance_exec: Improve error on openpty
      git cherry-pick 1ae663e768d76b72e9846982b3aee641eab95fe3  # lxd/util: Extend tests for CanonicalNetworkAddress
      git cherry-pick 2b799a43640f3c8fea9463e74f99bf3537c7e15b  # lxd/devlxd: Don't expand format strings
      git cherry-pick 91dbf44056242aebea32defc9eb4d90a652bdee1  # tests: Test for format string in devlxd
      git cherry-pick 955c005042ab1baf77a4deb3c3d839da843b7529  # lxd/instance: Prevent deleting volatile keys
      git cherry-pick 3a35bf42fc9635d3499ea16ba3c4d1875529ac95  # lxd/instance: Update tests
      git cherry-pick 5836a2041989a269ddbd156b0fc468a5af3976d2  # lxd/instance: Don't allow root pool changes
      git cherry-pick 5d715eae49436e8eb4f7eae0687a39680559aee1  # tests: Test root disk device pool override
      git cherry-pick ba32c048577261081fe15e420b2cb5e6c466da20  # tests: Fix typo in storage_profiles test
      git cherry-pick 4dd3fd74ba55b868825a80862a821f4e20764621  # doc: make it explicit that automake is needed to build LXD
      git cherry-pick 12c13b0389e75a45f11602768b82b54507bd31ff  # doc: LXD requires Golan 1.18 now
      git cherry-pick 82eda2694b12f6eea094703b2de26610441526c2  # lxd/main_init_interactive: Mention port
      git cherry-pick 20668eeb326c7cd8f96f080140e8df1edeaf828c  # lxd/db/generate/db/method/v2: Create methods for reference tables
      git cherry-pick 8c5b248167b06ca3b4e7ddda89d2fc37e18d5efb  # lxd/db/projects: Use v2 generator, remove UsedBy/Config fields
      git cherry-pick a9e6bf2c2a3760e4d3e312de5efff708f7bd2986  # lxd/db/projects.mapper: Update generated code
      git cherry-pick 9f4aeb4b624b7cf0dcbb3d7beb0a72e53d4d8b21  # lxd/db/projects: Populate config in ToAPI
      git cherry-pick df284e5ee48f7293c41547908afc3f70e62b72b6  # lxd/db/projects: Use GetProjectConfig
      git cherry-pick 330a90e17b9ca6f90a985016d1eb3af8d5ca16ad  # lxd/db/projects: Removed UsedBy handling from db package
      git cherry-pick 334e331d5c47bb574dc98cdcb84773db32c610c6  # lxd/storage/drivers/zfs: Check if raw flag can be used
      git cherry-pick f91b8c9e215a1ba3df42565bd9c18144a7217f71  # lxd/storage/drivers/zfs: Use -w in `zfs send` if possible
      git cherry-pick b556879294de8a3ce465e47ec74a963b48cf361f  # shared/subprocess: Fix comment
      git cherry-pick 96198fee3898b3078e42b87af8b17621a30f9312  # shared/api: Update to new godoc comment
      git cherry-pick f91201cea495c7e8448643c0264a6317a4b592fc  # client: Update to new godoc syntax
      git cherry-pick 9d9f88406ca9828a962b565dfca3c53f4d89f2a9  # lxd/api/project: Add projectUsedBy
      git cherry-pick 7fda0cada962fbfc08d37b6be79a7e38b9b57555  # shared/api/project: Add URL method
      git cherry-pick c49cd9fdb0a345676f620a9aaa0ec2685040814f  # lxd/storage/volumes/utils: Use api.Project for InstanceList
      git cherry-pick 7392d6bf231a259159f95437b83c6466bc09065d  # lxd/api/project: Use api.Project over db.Project
      git cherry-pick 18e8b43636eb936e896d736cceb1bfcdd27a7c1e  # lxd: manually fetch project Config or use api struct
      git cherry-pick 93de35596702f1e9dea1382cedd787673f0bee99  # lxd/project/permissions/test: Fix tests
      git cherry-pick 6096458d3a75623ea4d2e604a6fb0f5f4ba10424  # lxd/api/project: Return immediately if project is used
      git cherry-pick 502548d093aa0011aa19c52df3c194b5e207ed81  # shared/cert: Update test certs to EC
      git cherry-pick ecc0390e843da3dcff9661c5d357b03b9d6982de  # Revert "Skip clustering-related unit tests, see issue #6122"
      git cherry-pick 19ca58f62695260cc46465a9a510fc297abe6d4b  # lxd: Remove old clustering tests
      git cherry-pick b1e85cd53182ff9e606b09b03f5c94ff5f616e5b  # lxd/cluster/connect: Modify ConnectIfInstanceIsRemote to return a client configured with project
      git cherry-pick 69ce28e9c1064d2c8fbc6bfb43c8f598a826de10  # lxd/instance/console: Use api.NewURL in instanceConsolePost
      git cherry-pick da91af6f24a6dbda0d570857f429c892d60fd9ff  # lxd/instance/exec: Use api.NewURL in instanceExecPost
      git cherry-pick fca44041833375f99e3780db929444dd0deb03a4  # lxd: No need to use UseProject() with client from ConnectIfInstanceIsRemote
      git cherry-pick ce31d10996647a515bd92319c291fc640eceef9f  # lxd/migrate: Adds migrationControlResponse type
      git cherry-pick 1233e65a33afd898830364ae76e951c7e10f91db  # lxd/migrate: Update controlChannel to return migrationControlResponse
      git cherry-pick c04b054da6f65602284be248984872d622b6ff26  # lxd: golint fixes
      git cherry-pick 4e3c8939c7677ad1b036780c2d46420aa42c2b28  # lxd/migrate/instance: migrationControlResponse usage
      git cherry-pick 3c5c0d84d04c46f8ae1fba5b0786bc34219dca11  # lxd/migrate/storage/volumes: migrationControlResponse usage
      git cherry-pick 7b2092387ce74ce910c09cf30df5ffbb4ed4f0bb  # lxd/device/device/utils/disk: Look for QEMU helpers in /usr/libexec/
      git cherry-pick a454256593384ae5f9535bd48e3c9bd88cfb955b  # lxd: Switch to using api.StatusErrorCheck where appropriate
      git cherry-pick 02752018678899311d63a3459157fed51ac9dfe5  # lxd/db/generate: Update to use api.StatusErrorCheck
      git cherry-pick a35f015b2731af68a3461ef31ff19d002ab68362  # lxd/db: Regenerates DB functions
      git cherry-pick 11aa39bee34c0e614efe939e8ddace382e7e94bf  # lxd/storage/drivers/zfs: send -w is possible since 0.8.0
      git cherry-pick ac607cf07a4f268c9d0fcbe51f3a0e24ef545033  # lxd/state: Make InstanceTypes store errors
      git cherry-pick 529e5a26a318909fa0afd5120caa8bf9861d7e0c  # lxd/instance/drivers: Replace SupportedInstanceTypes with DriverStatuses
      git cherry-pick a8673756b0a10fe60169aa43eae963330d838a49  # lxd: DriverStatuses usage
      git cherry-pick f798689ccb259def00047c5cec426f5ccf66f87f  # lxd/instance: Report driver errors
      git cherry-pick a622172fed1645cdf771f5099fde70b2a03bae60  # lxd/instance/qemu: Improve errors in Info
      git cherry-pick 14c88e2812f62270c700b725014151c23f6cc7f9  # lxd-agent: Fix trans= handling
      git cherry-pick 07676c48ccd7491bedb912215f29d0ef3387ec9f  # lxd/instance/drivers/driver/qemu: Update Export to use qemu-img convert in direct I/O mode
      git cherry-pick 41a60caca7efdef647fcf1f08920f97ef577c374  # lxd/storage/utils: Updates ImageUnpack to use qemu-img convert in direct I/O mode
      git cherry-pick b5149552207adceb3fa077968e13c8c872f7acd8  # lxd/storage/drivers/utils: Update copyDevice to open files in read only mode
      git cherry-pick d8100581a3645bac4dba38416fc0d2c2dfc9abfa  # lxd/storage/drivers/driver/dir/volumes: Reduce var scope in CreateVolumeSnapshot
      git cherry-pick 667093aec7b29e528c7b4cdba083808276d38a91  # lxd/storage/drivers/driver/dir/volumes: Use dd to restore block volumes in RestoreVolume
      git cherry-pick e1ce0b8b58496804217b0d7c1ce36bf8936bdd1c  # lxd/instance: Enforce a 64 chars device name limit
      git cherry-pick 24f6cb7b71a06c330fa9c5a70a73c0bd5fe62d7e  # doc/instances: Mention 64 chars limit on device names
      git cherry-pick 2b10c198086fc18abff5bd6acf605f906e38e79b  # lxd/device/disk: Drop 27 chars limit
      git cherry-pick a026affe52b11a1c68ffc345f195c291a55774e3  # lxd/storage/utils: Disable format detection in qemu-img info in ImageUnpack
      git cherry-pick 13ede0e3a40a45b54d0c551683ec6726f9d3aa4f  # lxd/instance/qemu: Use a hash for long disk names
      git cherry-pick fd13fdd542a5964466195d695246a8d0dc6b9053  # lxd/instance: Fix Update calls for ephemeral instances
      git cherry-pick 8a6fd0ae8be4d7ac94620c28ac539a50b88790c5  # tests: Add restart test for ephemeral instances
      git cherry-pick 3c06b4725b9e365054fb3d72fc2bf69883626b73  # lxd/db/generate: Don't list bash completion
      git cherry-pick 02343001f0c03a603aa249fd8777d1aeb14e2594  # lxd/storage: Forward instance volume state request
      git cherry-pick b517a443bc5c0b6f9c6581d7cacf2d9f016393a4  # client: Add GetMetrics
      git cherry-pick 709cc124a1106e1ad8b538110c800b5985901b43  # lxd/device/proxy: Fix comment typo
      git cherry-pick 13d8168b4cc313033e33145595a7171f4d880b71  # doc: Remove user-facing mentions of cluster node
      git cherry-pick 79df182108528021860328fc0987c5b9580c34f8  # lxd: Replace local node mentions with local member
      git cherry-pick ac6b443c1f6d0a3583d91fc40c199f8108ea4bb4  # lxd/api/cluster: Request that projects with restricted.networks be created first in clusterInitMember
      git cherry-pick 98c9ed0b05723a880588f846796ec1f9625a50cb  # lxd/init: Re-arrange initDataNodeApply order
      git cherry-pick 47ddf104041cbe606e1206bd16d07f38042b99bc  # lxd/init: Error quoting in initDataNodeApply
      git cherry-pick edef4b884062a84169da6a4548d5695d9ca7e3e5  # lxd/init: Create relevant networks before and after projects in initDataNodeApply
      git cherry-pick fb3d80cab2b911a4070b32ceb5b14db9e55c3ce8  # test: Check that default project networks are created before projects during cluster member join
      git cherry-pick f7b59b225c5f52f0c580a53c4dd8094e5d13e7cf  # doc/reference/network/bridge: Clarify ipv{n}.nat default value added when creating networks
      git cherry-pick 4ad77a056583a2b1fd636439682f104227ef8db9  # lxd/instance/drivers/driver/qemu: Catch stateful resume errors in Snapshot
      git cherry-pick ab6745cf3e9292e1d5e0b34cc842186853543fdb  # lxd/instance/drivers/driver/qemu: Pass nvram file by FD and make writable by QEMU process
      git cherry-pick 56fd5527c0f3c7f6b6f5d56ac83fbb22395f07ee  # lxd/console: Move PTS logic to LXC driver
      git cherry-pick 22b0e36760831fbab1dade1c06b0689c4b076064  # lxd/instance/qemu: Switch to socket for console
      git cherry-pick aa9fee41cb65920f45d8af5167bd571b94573115  # lxd/apparmor: Treat ramfs the same as tmpfs
      git cherry-pick d5369d750d30a0b9fa3501cc7ba8e6beb6c9efd3  # lxd/network/driver/sriov: Mark network as available on successful start
      git cherry-pick 6360743831c1dc812ce9e3dde30137a616650edc  # lxd/instance/drivers/driver/qemu: Centralise logic for UEFI architecture detection
      git cherry-pick 31aa5c775373586c54b3f8a936858d787bf2cf6d  # lxd/instance/drivers/driver/qemu: Only use NVRAM firmware template on UEFI architectures
      git cherry-pick 4a6c9557e9ad71ad599a8b2a172e31433fb68d31  # lxd/instance/drivers/driver/qemu/templates: Removes duplicated arch check in qemuDriveFirmware

      # Setup build environment
      export GOPATH=$(realpath ./.go)
      export CGO_CFLAGS="-I${SNAPCRAFT_STAGE}/include/ -I${SNAPCRAFT_STAGE}/usr/local/include/"
      export CGO_LDFLAGS="-L${SNAPCRAFT_STAGE}/lib/ -L${SNAPCRAFT_STAGE}/usr/local/lib/"
      export CGO_LDFLAGS_ALLOW="(-Wl,-wrap,pthread_create)|(-Wl,-z,now)"

      # Build the binaries
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxc" github.com/lxc/lxd/lxc
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxc-to-lxd" github.com/lxc/lxd/lxc-to-lxd
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd" -tags=libsqlite3 github.com/lxc/lxd/lxd
      CGO_ENABLED=0 go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-agent" -tags=agent,netgo github.com/lxc/lxd/lxd-agent
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-benchmark" github.com/lxc/lxd/lxd-benchmark
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-user" github.com/lxc/lxd/lxd-user

      # Setup bash completion
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/
      cp scripts/bash/lxd-client ${SNAPCRAFT_PART_INSTALL}/etc/bash_completion.d/snap.lxd.lxc
    organize:
      usr/bin/: bin/
      usr/lib/: lib/
      usr/share/misc/: share/misc/
      var/lib/usbutils/usb.ids: share/misc/
      usr/sbin/: bin/
      sbin/: bin/
    prime:
      - bin/dnsmasq
      - bin/getfattr
      - bin/setfattr
      - bin/iw
      - bin/pigz
      - bin/rsync
      - bin/setfacl
      - bin/sgdisk
      - bin/unsquashfs
      - bin/xdelta3

      - lib/*/libidn.so.*

      - etc/bash_completion.d/snap.lxd.lxc

      - share/misc

      - bin/lxc
      - bin/lxc-to-lxd
      - bin/lxd
      - bin/lxd-agent
      - bin/lxd-benchmark
      - bin/lxd-user

  lxd-migrate:
    build-attributes: [core22-step-dependencies]
    source: lxd-migrate/
    after:
      - lxd
      - sqlite
    build-snaps:
      - go
    plugin: nil
    override-pull: |
      snapcraftctl pull
      set -ex

      # Setup build environment
      export GOPATH=$(realpath ./.go)

      # Download the dependencies
      go get -d -v ./...
    override-build: |
      set -ex

      # Setup build environment
      export GOPATH=$(realpath ./.go)
      export CGO_CFLAGS="-I${SNAPCRAFT_STAGE}/include/ -I${SNAPCRAFT_STAGE}/usr/local/include/"
      export CGO_LDFLAGS="-L${SNAPCRAFT_STAGE}/lib/ -L${SNAPCRAFT_STAGE}/usr/local/lib/"

      # Build the binaries
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/lxd-migrate" -tags=libsqlite3 ./

      # Install bridge script
      mkdir -p ${SNAPCRAFT_PART_INSTALL}/bin/
      cp scripts/upgrade-bridge ${SNAPCRAFT_PART_INSTALL}/bin/upgrade-bridge
    prime:
      - bin/lxd-migrate
      - bin/upgrade-bridge

  shmounts:
    build-attributes: [core22-step-dependencies]
    source: shmounts/
    plugin: make
    prime:
      - bin/setup-shmounts

  snap-query:
    build-attributes: [core22-step-dependencies]
    source: snap-query/
    build-snaps:
      - go
    plugin: nil
    override-build: |
      set -ex

      # Setup build environment
      export GOPATH=$(realpath ./.go)

      # Build the binaries
      go build -o "${SNAPCRAFT_PART_INSTALL}/bin/snap-query" snap-query.go
    prime:
      - bin/snap-query

  strip:
    build-attributes: [core22-step-dependencies]
    source: snapcraft/empty
    after:
      - btrfs
      - ceph
      - dqlite
      - libseccomp
      - logrotate
      - lvm
      - nano
      - nvidia-container
      - openvswitch
      - ovn
      - raft
      - sqlite
      - squashfs-tools-ng
      - vim
      - xfs
      - xz
      - zfs-0-6
      - zfs-0-7
      - zfs-0-8
      - zfs-2-0
      - zfs-2-1
      - lxc
      - lxcfs
      - criu
      - lxd
      - lxd-migrate
      - shmounts
      - snap-query
    plugin: nil
    override-prime: |
      set -x

      # Strip some of the heavy bits
      strip -s ${SNAPCRAFT_PRIME}/bin/lxc
      strip -s ${SNAPCRAFT_PRIME}/bin/lxd*
      strip -s ${SNAPCRAFT_PRIME}/bin/snap*
      strip -s ${SNAPCRAFT_PRIME}/lib/liblxc*
      strip -s ${SNAPCRAFT_PRIME}/lib/libdqlite*
      strip -s ${SNAPCRAFT_PRIME}/lib/libsqlite*

      for zfs in zfs-0.6 zfs-0.7 zfs-0.8 zfs-2.0 zfs-2.1; do
          [ ! -d "${SNAPCRAFT_PRIME}/${zfs}" ] && continue
          strip -s ${SNAPCRAFT_PRIME}/${zfs}/bin/* ${SNAPCRAFT_PRIME}/${zfs}/lib/*
      done

      [ -e "${SNAPCRAFT_PRIME}/criu/criu" ] && strip -s ${SNAPCRAFT_PRIME}/criu/criu

      exit 0

  wrappers:
    build-attributes: [core22-step-dependencies]
    plugin: dump
    source: snapcraft/
    organize:
      hooks/: snap/hooks/
      wrappers/editor: bin/
      wrappers/remote-viewer: bin/
      wrappers/sshfs: bin/
